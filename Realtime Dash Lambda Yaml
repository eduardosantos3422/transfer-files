AWSTemplateFormatVersion: "2010-09-09"
Description: "Lambda (ZIP from S3) + IAM (Connect + Secrets) + VPC access to RDS + EventBridge Scheduler schedules (Hawaii time + every minute)"

Parameters:
  # ---- Lambda code ----
  FunctionName:
    Type: String
    Default: connect-reltime-dash

  CodeS3Bucket:
    Type: String
    Description: "S3 bucket containing the Lambda zip"

  CodeS3Key:
    Type: String
    Description: "S3 key to the Lambda zip (e.g., connect-reltime-dash/function.zip)"

  Runtime:
    Type: String
    Default: nodejs22.x
    AllowedValues: [nodejs18.x, nodejs20.x, nodejs22.x]

  Handler:
    Type: String
    Default: index.handler

  MemorySize:
    Type: Number
    Default: 512
    MinValue: 128
    MaxValue: 10240

  Timeout:
    Type: Number
    Default: 60
    MinValue: 1
    MaxValue: 900

  LogRetentionDays:
    Type: Number
    Default: 14
    AllowedValues: [1,3,5,7,14,30,60,90,120,150,180,365,400,545,731,1827,3653]

  # ---- VPC (for RDS access) ----
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: "VPC where Lambda ENIs will be created (same VPC as RDS)"

  LambdaSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: "Private subnets (2+ AZs recommended) where Lambda will run"

  # ---- DB connection settings (passed to Lambda as env vars) ----
  DbHost:
    Type: String
    Description: "RDS endpoint hostname (no port), e.g. awsconnectmetrics.xxxxxx.us-west-2.rds.amazonaws.com"

  DbPort:
    Type: Number
    Default: 3306

  DbName:
    Type: String
    Default: awsconnectmetrics

  DbSecretArn:
    Type: String
    Description: "Secrets Manager secret ARN containing JSON with username/password"

  # ---- Amazon Connect ----
  ConnectInstanceArn:
    Type: String
    Description: "Amazon Connect instance ARN (for IAM scoping)"

  ConnectInstanceId:
    Type: String
    Default: "e7dbe8a6-c58d-4bcf-8398-78358c97c685"

Resources:
  # =========================
  # Lambda Security Group
  # =========================
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "Lambda SG for ${FunctionName} (allow egress; add this SG as inbound source on RDS:3306)"
      VpcId: !Ref VpcId

  # =========================
  # Lambda Execution Role
  # =========================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${FunctionName}-role-${AWS::StackName}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        # CloudWatch Logs
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        # Required when Lambda runs in a VPC (ENIs)
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: !Sub "${FunctionName}-connect-secrets"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Read DB creds from Secrets Manager
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref DbSecretArn

              # If your Secrets Manager secret uses a customer-managed KMS key, you may need kms:Decrypt.
              # Keeping "*" avoids CMK-ARN plumbing; tighten later if desired.
              - Effect: Allow
                Action:
                  - kms:Decrypt
                Resource: "*"

              # Amazon Connect read/list/describe + search (common for dashboards + inventory sync)
              - Effect: Allow
                Action:
                  - connect:Describe*
                  - connect:List*
                  - connect:Get*
                  - connect:SearchUsers
                  - connect:SearchQueues
                  - connect:SearchRoutingProfiles
                  - connect:SearchHoursOfOperations
                  - connect:SearchPrompts
                  - connect:SearchQuickConnects
                Resource: !Ref ConnectInstanceArn

              # NOTE: If you get AccessDenied because an API doesn't support resource-level perms,
              # switch Resource to "*" for that action.
              # - Effect: Allow
              #   Action: [ "connect:ListUsers" ]
              #   Resource: "*"

  # =========================
  # Lambda Function
  # =========================
  LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref FunctionName
      Runtime: !Ref Runtime
      Handler: !Ref Handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref CodeS3Bucket
        S3Key: !Ref CodeS3Key
      MemorySize: !Ref MemorySize
      Timeout: !Ref Timeout
      Architectures: [x86_64]

      VpcConfig:
        SubnetIds: !Ref LambdaSubnetIds
        SecurityGroupIds:
          - !GetAtt LambdaSecurityGroup.GroupId

      Environment:
        Variables:
          DB_HOST: !Ref DbHost
          DB_PORT: !Ref DbPort
          DB_NAME: !Ref DbName
          DB_SECRET_ARN: !Ref DbSecretArn
          CONNECT_INSTANCE_ARN: !Ref ConnectInstanceArn
          CONNECT_INSTANCE_ID: !Ref ConnectInstanceId

  # Explicit log group so you control retention
  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${FunctionName}"
      RetentionInDays: !Ref LogRetentionDays

  # =========================
  # Scheduler role (invokes Lambda)
  # =========================
  SchedulerInvokeLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "scheduler-invoke-${FunctionName}-${AWS::StackName}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeLambda
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt LambdaFunction.Arn

  # =========================
  # Schedules (6)
  # =========================

  # Every minute: insertAgentMetric
  ScheduleInsertAgentMetricEveryMinute:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub "insertAgentMetric-every-minute-${AWS::StackName}"
      State: ENABLED
      FlexibleTimeWindow: { Mode: "OFF" }
      ScheduleExpression: "rate(1 minute)"
      Target:
        Arn: !GetAtt LambdaFunction.Arn
        RoleArn: !GetAtt SchedulerInvokeLambdaRole.Arn
        Input: !Sub |
          {
            "InstanceId": "${ConnectInstanceId}",
            "Method": "insertAgentMetric",
            "DatabaseName": "${DbName}"
          }

  # Every minute: insertQueueMetric
  ScheduleInsertQueueMetricEveryMinute:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub "insertQueueMetric-every-minute-${AWS::StackName}"
      State: ENABLED
      FlexibleTimeWindow: { Mode: "OFF" }
      ScheduleExpression: "rate(1 minute)"
      Target:
        Arn: !GetAtt LambdaFunction.Arn
        RoleArn: !GetAtt SchedulerInvokeLambdaRole.Arn
        Input: !Sub |
          {
            "InstanceId": "${ConnectInstanceId}",
            "Method": "insertQueueMetric",
            "DatabaseName": "${DbName}"
          }

  # Daily 1:00 AM Hawaii: listQueues
  ScheduleListQueues_0100HST:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub "listQueues-0100HST-${AWS::StackName}"
      State: ENABLED
      FlexibleTimeWindow: { Mode: "OFF" }
      ScheduleExpressionTimezone: "Pacific/Honolulu"
      ScheduleExpression: "cron(0 1 * * ? *)"
      Target:
        Arn: !GetAtt LambdaFunction.Arn
        RoleArn: !GetAtt SchedulerInvokeLambdaRole.Arn
        Input: !Sub |
          {
            "InstanceId": "${ConnectInstanceId}",
            "Method": "listQueues",
            "DatabaseName": "${DbName}"
          }

  # Daily 1:05 AM Hawaii: listRoutingProfiles
  ScheduleListRoutingProfiles_0105HST:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub "listRoutingProfiles-0105HST-${AWS::StackName}"
      State: ENABLED
      FlexibleTimeWindow: { Mode: "OFF" }
      ScheduleExpressionTimezone: "Pacific/Honolulu"
      ScheduleExpression: "cron(5 1 * * ? *)"
      Target:
        Arn: !GetAtt LambdaFunction.Arn
        RoleArn: !GetAtt SchedulerInvokeLambdaRole.Arn
        Input: !Sub |
          {
            "InstanceId": "${ConnectInstanceId}",
            "Method": "listRoutingProfiles",
            "DatabaseName": "${DbName}"
          }

  # Daily 1:10 AM Hawaii: hierarchyGroup
  ScheduleHierarchyGroup_0110HST:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub "hierarchyGroup-0110HST-${AWS::StackName}"
      State: ENABLED
      FlexibleTimeWindow: { Mode: "OFF" }
      ScheduleExpressionTimezone: "Pacific/Honolulu"
      ScheduleExpression: "cron(10 1 * * ? *)"
      Target:
        Arn: !GetAtt LambdaFunction.Arn
        RoleArn: !GetAtt SchedulerInvokeLambdaRole.Arn
        Input: !Sub |
          {
            "InstanceId": "${ConnectInstanceId}",
            "Method": "hierarchyGroup",
            "DatabaseName": "${DbName}"
          }

  # Daily 1:15 AM Hawaii: listAgents
  ScheduleListAgents_0115HST:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub "listAgents-0115HST-${AWS::StackName}"
      State: ENABLED
      FlexibleTimeWindow: { Mode: "OFF" }
      ScheduleExpressionTimezone: "Pacific/Honolulu"
      ScheduleExpression: "cron(15 1 * * ? *)"
      Target:
        Arn: !GetAtt LambdaFunction.Arn
        RoleArn: !GetAtt SchedulerInvokeLambdaRole.Arn
        Input: !Sub |
          {
            "InstanceId": "${ConnectInstanceId}",
            "Method": "listAgents",
            "DatabaseName": "${DbName}"
          }

Outputs:
  LambdaArn:
    Description: "Deployed Lambda ARN"
    Value: !GetAtt LambdaFunction.Arn

  LambdaSecurityGroupId:
    Description: "IMPORTANT: Add this SG as an INBOUND source on the RDS SG for port 3306"
    Value: !GetAtt LambdaSecurityGroup.GroupId

  SchedulerRoleArn:
    Description: "Role used by EventBridge Scheduler to invoke Lambda"
    Value: !GetAtt SchedulerInvokeLambdaRole.Arn
