AWSTemplateFormatVersion: "2010-09-09"
Description: "PROD: RDS MySQL awsconnectmetrics (defaults below are DEV so PROD team can replace)"

Parameters:
  DBInstanceIdentifier:
    Type: String
    Default: awsconnectmetrics

  MasterUsername:
    Type: String
    Default: admin

  MasterUserPassword:
    Type: String
    NoEcho: true
    Description: "Set the admin password (or switch to Secrets Manager)."

  # ====== PROD TEAM MUST CHANGE THESE ======
  VpcId:
    Type: String
    Default: vpc-03efbbf8f2b6321b6
    Description: "DEV value shown. CHANGE to PROD VPC Id."

  SubnetIds:
    Type: List<String>
    Default: "subnet-08c5ab36af24a02c4,subnet-03b0db226a6b85e69"
    Description: "DEV subnets shown. CHANGE to PROD private subnets (2+ AZs)."

  # If PROD already has a subnet group, you can pass its name and skip creation.
  ExistingDBSubnetGroupName:
    Type: String
    Default: rds-cluster-subnet-group-1
    Description: "DEV subnet group name shown. CHANGE to PROD subnet group name, or leave blank to create one."
  
  VpcSecurityGroupIds:
    Type: List<String>
    Default: "sg-0ea52763d77b672ea,sg-02e46d4b0de1ba909"
    Description: "DEV SGs shown. CHANGE to PROD SG ids (e.g., default + rds-lambda-3 equivalent)."

Conditions:
  UseExistingSubnetGroup: !Not [!Equals [!Ref ExistingDBSubnetGroupName, ""]]

Resources:
  # Create a subnet group only if user does NOT provide an existing name
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Condition: !Not [UseExistingSubnetGroup]
    Properties:
      DBSubnetGroupDescription: !Sub "Subnet group for ${DBInstanceIdentifier}"
      SubnetIds: !Ref SubnetIds

  AwsConnectMetricsDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Ref DBInstanceIdentifier

      Engine: mysql
      EngineVersion: "8.0.43"
      DBInstanceClass: db.m7g.large
      LicenseModel: general-public-license

      MasterUsername: !Ref MasterUsername
      MasterUserPassword: !Ref MasterUserPassword

      # Networking (DEV defaults are in the Parameters above; PROD swaps them)
      DBSubnetGroupName: !If
        - UseExistingSubnetGroup
        - !Ref ExistingDBSubnetGroupName
        - !Ref DBSubnetGroup

      VPCSecurityGroups: !Ref VpcSecurityGroupIds
      PubliclyAccessible: false
      Port: 3306
      NetworkType: IPV4

      # Storage (matches your instance)
      StorageType: gp3
      AllocatedStorage: 200
      MaxAllocatedStorage: 1000
      Iops: 3000
      StorageThroughput: 125
      StorageEncrypted: true

      # Monitoring & logs (matches your instance)
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      MonitoringInterval: 60
      EnableCloudwatchLogsExports:
        - slowquery

      # Matches screenshot
      MultiAZ: false
      DeletionProtection: false
      CopyTagsToSnapshot: true

Outputs:
  DbEndpoint:
    Value: !GetAtt AwsConnectMetricsDB.Endpoint.Address
  DbPort:
    Value: !GetAtt AwsConnectMetricsDB.Endpoint.Port
  DbInstanceArn:
    Value: !GetAtt AwsConnectMetricsDB.DBInstanceArn
